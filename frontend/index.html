<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Management System</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background-color:#f4f4f9; }
    header { background-color:#3f51b5; color:white; padding:20px 0; text-align:center; }
    header h1 { margin:0; }
    nav { background-color:#303f9f; display:flex; justify-content:center; flex-wrap:wrap; }
    nav a { color:white; padding:14px 20px; text-decoration:none; text-transform:uppercase; }
    nav a:hover { background-color:#1a237e; }
    .container { max-width:1000px; margin:20px auto; padding:0 20px; }
    h2 { color:#303f9f; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    table, th, td { border:1px solid #ddd; }
    th, td { padding:12px; text-align:left; }
    th { background-color:#3f51b5; color:white; }
    tr:nth-child(even) { background-color:#f2f2f2; }
    form { background-color:white; padding:20px; margin-top:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    form input, form select { padding:10px; margin:8px 0; width:100%; box-sizing:border-box; }
    form button { background-color:#3f51b5; color:white; padding:10px 20px; border:none; cursor:pointer; margin-top:10px; }
    form button:hover { background-color:#303f9f; }
    .no-data { text-align:center; color:#555; padding:10px; }
  </style>
</head>

<body>
  <header>
    <h1>Library Management System</h1>
  </header>

  <nav>
    <a href="#book-list">Book List</a>
    <a href="#add-book">Add Book</a>
    <a href="#search-book">Search Book</a>
    <a href="#fine-management">Fine Management</a>
  </nav>

  <div class="container">
    <!-- Book List Section -->
    <section id="book-list">
      <h2>Book List</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Author</th>
            <th>Genre</th>
            <th>Availability</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="no-books" class="no-data"></div>
    </section>

    <!-- Add Book Section -->
    <section id="add-book">
      <h2>Add New Book</h2>
      <form id="add-book-form">
        <input type="text" placeholder="Book Title" required>
        <input type="text" placeholder="Author" required>
        <input type="text" placeholder="Genre" required>
        <select>
          <option value="Available">Available</option>
          <option value="Issued">Issued</option>
        </select>
        <button type="submit">Add Book</button>
      </form>
    </section>

    <!-- Search Book Section -->
    <section id="search-book">
      <h2>Search Book</h2>
      <form id="search-book-form">
        <input type="text" placeholder="Search by title or author">
        <label for="genre">Select Book Type:</label>
        <select id="genre" name="genre">
          <option value="">-- All Genres --</option>
          <option value="Fiction">Fiction</option>
          <option value="Fantasy">Fantasy</option>
          <option value="Science">Science</option>
          <option value="Biography">Biography</option>
          <option value="History">History</option>
          <option value="Technology">Technology</option>
          <option value="Education">Education</option>
          <option value="Mystery">Mystery</option>
          <option value="Self Help">Self Help</option>
        </select>
        <button type="submit">Search</button>
      </form>
    </section>

    <!-- Fine Management Section -->
    <section id="fine-management">
      <h2>Fine Management</h2>
      <table>
        <thead>
          <tr>
            <th>Borrower Name</th>
            <th>Book Title</th>
            <th>Issued Date</th>
            <th>Return Date</th>
            <th>Fine (₹)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="no-fines" class="no-data"></div>

      <h3>Add Fine Record</h3>
      <form id="add-fine-form">
        <input type="text" placeholder="Borrower Name" required>
        <input type="text" placeholder="Book Title" required>
        <input type="date" placeholder="Issued Date" required>
        <input type="date" placeholder="Return Date" required>
        <input type="number" placeholder="Fine Amount (₹)" required>
        <button type="submit">Add Record</button>
      </form>
    </section>
  </div>

  <script>
    /* --- Book Management --- */
    let books = [];
    const bookTableBody = document.querySelector("#book-list tbody");
    const noBooksDiv = document.getElementById("no-books");

    async function fetchBooks() {
      try {
        const res = await fetch("http://localhost:5000/api/books");
        books = await res.json();
        renderBooks(books);
      } catch (err) {
        alert("Error fetching books from server!");
        console.error(err);
      }
    }

    function renderBooks(list) {
      bookTableBody.innerHTML = "";
      if (!list.length) {
        noBooksDiv.textContent = "No books available.";
        return;
      }
      noBooksDiv.textContent = "";
      list.forEach(book => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${book.id}</td>
          <td>${book.title}</td>
          <td>${book.author}</td>
          <td>${book.genre}</td>
          <td>${book.availability}</td>
        `;
        bookTableBody.appendChild(tr);
      });
    }

    // Add book
    document.getElementById("add-book-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      const title = this.querySelector('input[placeholder="Book Title"]').value.trim();
      const author = this.querySelector('input[placeholder="Author"]').value.trim();
      const genre = this.querySelector('input[placeholder="Genre"]').value.trim();
      const availability = this.querySelector('select').value;

      try {
        const res = await fetch("http://localhost:5000/api/books", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, author, genre, availability })
        });
        const data = await res.json();
        alert(data.message);
        this.reset();
        fetchBooks();
      } catch (err) {
        alert("Error adding book!");
        console.error(err);
      }
    });

    // Search books
    document.getElementById("search-book-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const query = this.querySelector('input').value.trim().toLowerCase();
      const genre = this.querySelector('select').value.toLowerCase();
      const filtered = books.filter(book =>
        (book.title.toLowerCase().includes(query) || book.author.toLowerCase().includes(query)) &&
        (genre === "" || book.genre.toLowerCase() === genre)
      );
      renderBooks(filtered);
    });

    /* --- Fine Management --- */
    let fines = [];
    const fineTableBody = document.querySelector("#fine-management tbody");
    const noFinesDiv = document.getElementById("no-fines");

    async function fetchFines() {
      try {
        const res = await fetch("http://localhost:5000/api/fines");
        fines = await res.json();
        renderFines(fines);
      } catch (err) {
        alert("Error fetching fines!");
        console.error(err);
      }
    }

    function renderFines(list) {
      fineTableBody.innerHTML = "";
      if (!list.length) {
        noFinesDiv.textContent = "No fine records available.";
        return;
      }
      noFinesDiv.textContent = "";
      list.forEach(f => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${f.borrower}</td>
          <td>${f.title}</td>
          <td>${f.issued}</td>
          <td>${f.returned}</td>
          <td>${f.fine}</td>
        `;
        fineTableBody.appendChild(tr);
      });
    }

    // Add fine
    document.getElementById("add-fine-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      const borrower = this.querySelector('input[placeholder="Borrower Name"]').value.trim();
      const title = this.querySelector('input[placeholder="Book Title"]').value.trim();
      const issued = this.querySelector('input[placeholder="Issued Date"]').value;
      const returned = this.querySelector('input[placeholder="Return Date"]').value;
      const fine = Number(this.querySelector('input[placeholder="Fine Amount (₹)"]').value);

      if (new Date(returned) < new Date(issued)) {
        alert("Return date cannot be before issued date!");
        return;
      }

      try {
        const res = await fetch("http://localhost:5000/api/fines", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ borrower, title, issued, returned, fine })
        });
        const data = await res.json();
        alert(data.message);
        this.reset();
        fetchFines();
      } catch (err) {
        alert("Error adding fine record!");
        console.error(err);
      }
    });

    // Initial fetch
    fetchBooks();
    fetchFines();
  </script>

</body>
</html>
